# テスト戦略設計・実装設計

## 1. 目的
本ドキュメントは、Desktop Asset Manager のテスト戦略と、その実装方針を定義します。機能追加・設計変更時に品質を維持し、回帰を最小化することを目的とします。

## 2. 対象範囲
- UI（Qt）
- サービス層（AssetService／ConfigService）
- リポジトリ層（SQLite アクセス）
- DB 初期化とシードデータ

## 3. テスト方針
### 3.1 テスト階層
- 単体テスト：サービス層、リポジトリ層の振る舞いを検証
- 結合テスト：DB 初期化＋サービス連携を検証
- UI テスト：主要な UI 操作と状態反映を検証（オフスクリーン実行）

### 3.2 非機能観点
- 例外・競合時の挙動（使用中制約など）
- 既定ソート・フィルタ・ログの整合性
- シードデータの妥当性

## 4. テスト項目（概要）
- サービス
  - デバイス／ライセンスの作成・取得
  - 構成作成・名前変更
  - 割り当て／解除
  - 使用中制約（同一アセットの二重割り当て禁止）
- DB
  - 初期化とシード投入
  - 追加カラム（ライセンス番号、作成日／更新日）
- UI
  - 構成カード生成
  - 整列（構成番号・日時）
  - フィルタ／検索
  - 既定ソート（No 降順）
  - 使用中アセットのグレー表示とドラッグ不可

## 5. テストデータ戦略
- :memory: SQLite を使用し、テストごとに初期化
- 追加データはテスト内で明示的に作成
- シードデータは初期状態確認のみに使用

## 6. UI テスト設計
- PySide6 のオフスクリーンモードで実行
- ウィジェット生成 → refresh() → 状態検証
- テーブル／リストの行数、並び順、表示値を確認
- 使用中判定は list_assigned_* から反映されることを確認

## 7. 実装指針
- pytest を使用
- 例外が期待されるケースは pytest.raises を使用
- UI のイベント処理が必要な場合は app.processEvents() を実行

## 8. テスト設計と実装の対応
- 仕様（使用中制約）とテストケースが 1:1 で対応するように作成
- UI 仕様（表示・操作）とテスト項目を同期させて更新

## 9. 既存テストとの関係
- 既存の test_services_spec.py、test_detail_specs.py、test_ui_spec.py を拡張方針で維持
- 新規の仕様追加は同系統ファイルに追加する

## 10. 運用
- 変更後は pytest -q を必ず実行
- テスト失敗時は設計書の該当セクションを更新
